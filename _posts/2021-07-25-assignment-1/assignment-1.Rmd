---
title: "Assignment: 2021 VAST Mini Challenge 2"
description: |
  The Kronos Incident
author:
  - name: Connie Xia
    url: https://example.com/conniexia
date: 07-25-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.retina = 3,
                      echo = TRUE, 
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## Introduction

This Visual Analytics Assignment is based on the VAST Challenge 2021 Mini Challenge 2. The overview of the Challenge is about a Tethys-based GAStech that has been operating a natural gas production site in the island country og Kronos. Despite bringing in remarkable profits and developing strong relationships with the Kronos government, GAStech has not been as successful in demonstrating environmental stewardship.

In January 2014, while the leaders of GAStech were celebrating their successful initial public offering (IPO), several of the company's employees go missing. It is suspected that an organisation called the Protectors of Kronos (POK) was involved in the employees' disappearance, but things may not be what they seem. 

## The Mini Challenge
Mini Challenge 2 is about analysing the movement and tracking data of the GAStech employees, as well as their card card transactions and loyalty card usage data. From which, any anomalies and suspicious behaviours of the GAStech employees will be identified and analysed. 


## Literature Reviews
With reference to the 2014 VAST Mini Challenge 2, we are able to observe that some entries made use of calendar heat maps, geographic mappings and network diagrams to visualise the challenge. Similarly, we would also try these data visualisation methods in our analysis. 


## Data Sources
The data sources used in the mini challenge are:

Data sources | Description 
---------------- | ---------------- 
car-assignments.csv | List of vehicle assignments by employee
Geospatial folder | ESRI shapefiles of Abila and Kronos
gps.csv | Vehicle tracking data
loyalty_data.csv | Loyalty card transaction data
cc_data.csv | Credit and debit card transaction data
MC2-Tourist.jpg | Tourist map of Abila with locations of interest identified

## R Packages Used
Below are the list of R packages installed and used in this assignment. 

```{r}
packages = c('raster', 'sf', 'tmap', 'lubridate', 
             'tidyverse', 'igraph', 'tidygraph', 
             'ggraph', 'visNetwork', 'clock',
             'DT', 'zoo', 'parcoords', 'mapview')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```


## Location Analysis

### Data Preparation

The credit card and loyalty card csv files are first loaded into R. 

```{r}
cc_data <- read_csv("./data/cc_data.csv")
loyalty_data <- read_csv("./data/loyalty_data.csv")
```

Taking a look at the two datasets, we can observe that the *timestamp*, *location* and *loyaltynum* are in character field while *price* and *last4ccnum* are in numerical field. It is to be noted that the *timestamp* field should be in date-time format.

```{r}
glimpse(cc_data)
glimpse(loyalty_data)
```

Therefore, we need to convert the *timestamp* field in both datasets from character type to date-time type. 

```{r}
cc_data$timestamp <- date_time_parse(cc_data$timestamp,
                                     zone = "",
                                     format = "%m/%d/%Y %H:%M")

loyalty_data$timestamp <- date_time_parse(loyalty_data$timestamp,
                                          zone = "",
                                          format = "%m/%d/%Y")

```

Now, all the fields are in their correct data type.

```{r}
glimpse(cc_data)
glimpse(loyalty_data)
```

In order to have a better understanding and visualisation on how the credit card and loyalty card usage are related, we would need to join both datasets together. 

First, it is noted that the *timestamp* column in the *cc_data* dataset has both dates and time, while the *timestamp* column in the *loyalty_data* dataset only has the date field. So, we need to extract out the *date* from the *timestamp* column of the *cc_data*.

```{r}
cc_data$date <- format(cc_data$timestamp, "%m/%d/%Y")
cc_data$date <- date_time_parse(cc_data$date, 
                                zone = "", 
                                format = "%m/%d/%Y")

head(cc_data)
head(loyalty_data)
```

Now, we can join both datasets together by the *date*, *price* and *location*. A new column, *hour*, is added to take note of the time period the employee visited the location.

```{r}
cc_loyalty_data <- left_join(cc_data, loyalty_data,
                             by = c("date" = "timestamp",
                                    "location" = "location",
                                    "price" = "price"))

cc_loyalty_data$hour = hour(cc_loyalty_data$timestamp)
  
glimpse(cc_loyalty_data)
```

### Data Visualisation
Exploratory data analysis is conducted to determine the most popular locations frequented by the employees of GAStech. 

Looking at the combined dataset, we are able to observe that the top five most popular locations are:

1. Katerina's Cafe
2. Hippokampos
3. Guy's Gyros
4. Brew've Been Served
5. Hallowed Grounds

```{r}
freq_by_location <- cc_loyalty_data %>%
  select(location, price) %>%
  group_by(location) %>%
  summarise(total_price = sum(price), freq = n()) %>%
  arrange(desc(freq)) %>%
  ungroup()

ggplot(data=freq_by_location,
       aes(x = reorder(location, -freq), y = freq)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5)) + 
  ggtitle("Frequency of Visit") +
  labs(y = "Frequency", x = "Location")
```

Delving deeper into the top 5 most frequented places over the span of two weeks, we can plot a calendar heatmap to show the frequencies of purchases made at the top 5 most popular locations. 


```{r}
freq_by_date <- cc_loyalty_data %>%
  select(date, hour, location, price) %>%
  group_by(date, hour, location) %>%
  summarise(total_price = sum(price), freq = n()) %>%
  arrange(desc(freq)) %>%
  ungroup()

freq_by_date$weekday = as.POSIXlt(freq_by_date$date, format = "%d/%m/%Y")$wday

freq_by_date$weekdayf <- factor(freq_by_date$weekday, 
                                levels = rev(0:6),
                                labels = rev(c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
                                ordered = TRUE)

top5_plot <- freq_by_date %>%
  na.omit() %>%
  filter(location %in% c("Katerina's Cafe", "Hippokampos", "Guy's Gyros", "Brew've Been Served", "Hallowed Grounds"))

top5_heatmap <- ggplot(top5_plot, aes(hour, weekdayf, fill = top5_plot$freq)) +
  geom_tile(colour = "white") +
  facet_grid(~location) +
  theme(strip.text = element_text(size = 7)) +
  scale_fill_distiller(palette = "Reds", direction = 1) + 
  xlab("Hour") + 
  xlim(c(0,23)) +
  ylab("Day") + 
  ggtitle("Calendar Heatmap: Transaction Volume at Top 5 Locations") + 
  labs(fill = "Frequency")

top5_heatmap

```

The following observations and insights can be derived from the calendar heatmap:

1. All 5 locations are possibly dining places located in Abila inferred from the time period the employees visited those locations.
2. Brew've Been Served is a popular location during the weekdays around breakfast hours (0700-0800). Similarly, Hallowed Grounds is probably another popular breakfast place during the weekdays.
3. Guy's Gyros, Hippokampos and Katerina's Cafe are popular lunch (1300-1400) and dinner (1900-2100) spots throughout the entire week.

Moving on, two other calendar heatmaps are plotted to view the transaction volume comparison between weekdays and weekends. 

```{r}

weekday_plot <- freq_by_date %>%
  na.omit() %>%
  filter(weekday %in% c(1:5))

weekday_heatmap <- ggplot(weekday_plot, aes(hour, location, fill = weekday_plot$freq)) +
  geom_tile(colour = "white") +
  theme(strip.text = element_text(size = 7)) +
  scale_fill_distiller(palette = "Reds", direction = 1) + 
  xlab("Hour") + 
  xlim(c(0,23)) +
  ylab("Location") + 
  ggtitle("Calendar Heatmap: Transaction Volume during Weekdays") + 
  labs(fill = "Frequency")

weekday_heatmap

```

```{r}

weekend_plot <- freq_by_date %>%
  na.omit() %>%
  filter(weekday %in% c(0,6))

weekend_heatmap <- ggplot(weekend_plot, aes(hour, location, fill = weekend_plot$freq)) +
  geom_tile(colour = "white") +
  theme(strip.text = element_text(size = 7)) +
  scale_fill_distiller(palette = "Reds", direction = 1) + 
  xlab("Hour") + 
  xlim(c(0,23)) +  
  ylab("Location") + 
  ggtitle("Calendar Heatmap: Transaction Volume during Weekends") + 
  labs(fill = "Frequency")

weekend_heatmap

```

A boxplot show the spread of the transaction amount made by GAStech employees at different locations.

```{r}
median_price <- cc_loyalty_data %>%
  group_by(location) %>%
  summarise(median_price = median(price))

spending_by_location <- cc_loyalty_data %>%
  left_join(median_price, 
            by = c("location"))

ggplot(data = spending_by_location,
       aes(x = reorder(location, -median_price), y = price)) +
  geom_boxplot(outlier.colour = "Red", outlier.fill = "Red") +
  geom_point(alpha = 0) +
  scale_y_log10() +
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1,
                                   vjust = 0.5)) + 
  ggtitle("Transaction Amount by Location") +
  labs(y = "Spending amount", x = "Location")
``` 

Based on the above plots, we are able to spot a few anormalies that are note-worthy. 

1. Kronos Mart

From both the weekday and weekend calendar maps plotted above, there are transactions occurring at that location at the wee hours, when most people would be asleep. Further analysis revealed that there are a total of 5 transactions occurring on 3 different days (12 Jan, 13 Jan and 19 Jan) around 0300-0400 time period. The 5 transactions are all carried out on different credit cards, with no loyalty card used. It is also suspicious that the last two transactions occurred within the span of three minutes, suggesting a likely possibility that the last two card owners might have seen each other in the mart.

```{r}
knitr::kable(cc_loyalty_data %>%
               filter(location %in% "Kronos Mart" & hour %in% 3) %>%
               dplyr::select(location, timestamp, date, hour, price, last4ccnum, loyaltynum) %>%
               arrange(hour), "simple",
             caption = "Transactions made in Kronos Mart")
```


2. Frydos Autosupply n' More

Based on the boxplot plotted above, we are able to identify an outlier transaction at Frydos Autosupply n' More. There is an exceptionally high transaction of 10,000 dollars at the store where the median price is 149.30 dollars. Similarly, this transaction was not tagged to any loyalty card.  

```{r}
knitr::kable(spending_by_location %>%
               filter(location %in% "Frydos Autosupply n' More") %>%
               filter(price %in% max(price)) %>%
               dplyr::select(location, timestamp, date, hour, price, median_price, last4ccnum, loyaltynum),
             caption = "Transactions made in Frydos Autosupply n' More")
```

3. Daily Dealz

Despite being a low transaction amount, this purchase is rather suspicious as that is not tied to any loyalty card. The maximum, median and minimum transaction amounts also seem to be the same value, suggesting that it could be a singular purchase. This also means that not many people make purchases from Daily Dealz over the span of two weeks. Further analysis confirmed the suspicion. Furthermore, the credit card used to make the purchase is same as the credit card used to make the hefty purchase at Frydos Autosupply n' More. The timing where the transaction occurred is also rather suspicious as it is an early morning purchase.

```{r}
knitr::kable(spending_by_location %>%
               filter(location %in% "Daily Dealz") %>%
               dplyr::select(location, timestamp, date, hour, price, last4ccnum, loyaltynum) %>%
               arrange(hour), "simple",
             caption = "Transactions made in Daily Dealz")
```

4. Albert's Fine Clothing

Based on the boxplot plotted above, we are able to identify an outlier transaction at Albert's Fine Clothing. There is large transaction of 1,239.41 dollars compared to the median spending amount of 211.47 dollars. 

```{r}
knitr::kable(spending_by_location %>%
               filter(location %in% "Albert's Fine Clothing") %>%
               filter(price %in% max(price)) %>%
               dplyr::select(location, timestamp, date, hour, price, median_price, last4ccnum, loyaltynum), 
             caption = "Transactions made in Albert's Fine Clothing")
```

5. Chostus Hotel

Based on the boxplot plotted above, we are able to identify an outlier transaction at Chostus Hotel. There is a higher than average transaction of 600 dollars compared to the median spending amount of 114.22 dollars. 

```{r}
knitr::kable(spending_by_location %>%
               filter(location %in% "Chostus Hotel") %>%
               filter(price %in% max(price)) %>%
               dplyr::select(location, timestamp, date, hour, price, median_price, last4ccnum, loyaltynum), 
             caption = "Transactions made in Chostus Hotel")
```

6. Credit Card Number 9551

This credit card is highly suspicious due to the fact that it is used in three of the alleged suspicious transactions pointed out above at Kronos Mart, Frydos Autosupply n' More and Daily Dealz. Upon inspection of the card transaction detail, we can see that the card owner does have a loyalty card, but it seems like they tend to selectively use their loyalty card for discounts. 

Another dubious point to note is that for the first week, they use their credit card daily but during the next week, there are gaps in the transactions. Especially after 13 Jan (Mon), the credit card user stopped using their card for a few days before making transactions on 16 Jan (Thu).

```{r}
cc_loyalty_data$weekday = as.POSIXlt(cc_loyalty_data$date, format = "%d/%m/%Y")$wday

cc_loyalty_data$weekdayf <- factor(cc_loyalty_data$weekday, 
                                levels = rev(0:6),
                                labels = rev(c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
                                ordered = TRUE)

knitr::kable(cc_loyalty_data %>%
               filter(last4ccnum %in% 9551) %>%
               dplyr::select(timestamp, weekdayf, location, price, last4ccnum, loyaltynum), 
             caption = "Transactions made with CC 9551")
```

## Vehicle Data Analysis

Moving on, we will be analysing the vehicle data alongside with the credit and loyalty card transaction data.

First, the raster file, *M2-tourist.tif*, is imported into R.

```{r}
bgmap <- raster("./data/MC2-tourist.tif")

```

Next, the vector GIS data file, *Abila*, is imported into R.

```{r}
Abila_st <- st_read(dsn = "./data/Geospatial",
                    layer = 'Abila')

```

The vehicle tracking csv data file is also imported into R. 

```{r}
gps <- read_csv("./data/gps.csv")

glimpse(gps)
```

After taking a look at the *gps.csv* file, we converted the *Timestamp* field from character data type to date-time format. The *id* field is also converted from numerical data type to factor data type. 

```{r}
gps$Timestamp <- date_time_parse(gps$Timestamp,
                                 zone = "",
                                 format = "%m/%d/%Y %H:%M")

gps$day <- as.factor(get_day(gps$Timestamp))

gps$id <- as.factor(gps$id)
```

The gps dataframe is converted into a simple feature data frame.

```{r}
gps_sf <- st_as_sf(gps,
                   coords = c("long", "lat"),
                   crs = 4326)

glimpse(gps_sf)
```

The gps points are then joined together into movement paths by using the drivers' IDs as unique identifier.

```{r}
gps_path <- gps_sf %>%
  group_by(id, day) %>%
  summarise(m = mean(Timestamp),
            do_union = FALSE) %>%
  st_cast("LINESTRING")

glimpse(gps_path)
```

The map below shows the movement data of all the cars and trucks on the 6th Jan as an example.

```{r}
gps_path_selected <- gps_path %>%
  filter(day == 6)
tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_path_selected) +
  tm_lines() +
  tm_facets(by = "id", ncol = 4)
```

Next, the stationary points of all cars over the span of 2 weeks is plotted on the map below with the blue dots. The car is deeemd to be stationary if it has stopped for more than 3 minutes.

```{r}
POI <- gps_sf %>%
  group_by(id) %>%
  mutate(stoptime = Timestamp - lag(Timestamp)) %>%
  mutate(parked = ifelse(stoptime > 60*3, TRUE, FALSE)) %>%
  ungroup() %>%
  filter(parked == TRUE) %>%
  group_by(id, day) %>%
  add_count(id, day, name = "count") %>%
  ungroup()

POI_sf <- POI %>%
  filter(parked == TRUE)
tmap_mode("view")

tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(POI_sf) +
  tm_dots(col = "blue")

```

Going back to the anormalies assessment, we can use the vehicle tracking data to supplement our analysis.

1. The transaction amount made at Frydos Autosupply n’ More on 13 Jan is highly suspicious and needs to be investigated.

The credit card used to make that purchase ends with 9551. Hence, we can pull out all the transactions made on that card on 13 Jan. 

```{r}
knitr::kable(cc_loyalty_data %>%
               filter(last4ccnum == 9551 & date == dmy(13012014)) %>%
               dplyr::select(timestamp, location, price, last4ccnum, loyaltynum) %>%
               arrange(timestamp), "simple",
             caption = "Transactions made using CC 9551 on 13 Jan")
```

On 13 Jan, CC 9551 was used at Daily Dealz, U-Pump, Hippokampos, Frydos and Ouzeri Elian. 

The gps path of all vehicles on 13 Jan is plotted for reference. Looking at the map, we can observe that on 13 Jan, only Car ID 24 made a stop at U-Pump. Hence, it is worth investigating is the owner of the Car ID 24 is the same owner of CC 9551.


```{r}
gps_path_2 <- gps_path %>%
  filter(day==13)
tmap_mode("view")
tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_path_2) +
  tm_lines()
```

The stationary points of Car ID 24 on 13 Jan are as follows:

```{r}
knitr::kable(POI_sf %>%
               filter(id == 24 & day == 13) %>%
               dplyr::select(id, Timestamp, geometry) %>%
               arrange(Timestamp), "simple",
             caption = "GPS Path of Car ID 24 on 13 Jan")
```

```{r}
gps_24 <- gps_path %>%
  filter (day == 13 & id == 24)
  
POI_24 <- POI_sf %>%
  filter(id == 24 & day == 13)
tmap_mode("view")

tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(gps_24) +
  tm_lines() +
  tm_shape(POI_24) +
  tm_dots(col = "blue")
```

Observations:

* Car ID 24 left U-Pump at 13:22, corresponding to the transaction at U-Pump occurring at 13:18. 
* The user of Car ID 24 was near the area of Brew've Been Served at 19:29 whereas another transaction was made at Ouzeri Elian at 19:30.

Conclusion: 
The user of Car ID 24 and the holder of CC 9551 might not be the same person as the card and car records do not match perfectly, making the transactions on CC 9551 very suspicious. We can infer that perhaps the CC 9951 was used by more than one person. 


2. The next anormaly is the transactions made during the wee hours at Kronos Mart.

These five different transactions are all made by different credit cards, suggesting that it might be not a habit of an individual who prefers to grocery shop at night.

```{r}
knitr::kable(cc_loyalty_data %>%
               filter(location == "Kronos Mart" & hour == "3") %>%
               dplyr::select(timestamp, location, price, last4ccnum, loyaltynum) %>%
               arrange(timestamp), "simple",
             caption = "Transactions made at Kronos Mart during the wee hours")
```

Looking at the stationary points of the cars on 12, 13 and 19 Jan, we aren't able to point out which car is linked to the credit cards used at the mart. The only stationary points appearing near Kronos Mart are:

* 12 Jan, 13:58 
* 13 Jan, 13:38
* 19 Jan, 14:23

These timings all do not coincide with the timings in the wee hours.

```{r}
POI_midnight <- POI_sf %>%
  filter(day == c(12, 13, 19))
tmap_mode("view")

tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(POI_midnight) +
  tm_dots(col = "blue")
```

Conclusion:
The credit card holders of 8156, 5407, 3484, 9551 and 8332 either stay a walking distance from the Kronos Mart or they used their own personal cars instead of the company-provide cars to make the travel. 


3. Another anormaly has to do with the large transaction occurring at Albert's Fine Clothing and Chostus Hotel. 

Looking at the Albert's Fine Clothing suspicious transaction, we can see that the transaction occurred on 17 Jan at 19:44, using CC 1321 and L4149.

```{r}
knitr::kable(spending_by_location %>%
               filter(location %in% "Albert's Fine Clothing") %>%
               filter(price %in% max(price)) %>%
               dplyr::select(location, timestamp, date, hour, price, median_price, last4ccnum, loyaltynum), 
             caption = "Transactions made in Albert's Fine Clothing")
```

Hence, when we plot out the stationary locations on the map (on 17 Jan, between 1900-2000), we are able to observe that Car ID 11 left the clothing store at 19:46, which matched up to the suspicious transaction time. Hence, it can be implied that the owner of Car ID 11 might hold CC 1321 and L4149.

```{r}
POI_sf$hour = hour(POI_sf$Timestamp)

POI_clothing <- POI_sf %>%
  filter(day == 17 & hour == 19)
tmap_mode("view")

tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(POI_clothing) +
  tm_dots(col = "blue")
```


Similarly, we can see that the dubious transaction at Chostus Hotel occurred on 18 Jan at 12:03. The credit card in question is 5010, tied to a loyalty card L2459.

```{r}
knitr::kable(spending_by_location %>%
               filter(location %in% "Chostus Hotel") %>%
               filter(price %in% max(price)) %>%
               dplyr::select(location, timestamp, date, hour, price, median_price, last4ccnum, loyaltynum), 
             caption = "Transactions made in Chostus Hotel")
```

Plotting the stationary points on the map, we can see that Car ID 31 left the hotel at 12:35, which matches up with the transaction data. Hence, it is implied that the owner of Car ID 31 might be the holder of CC 5010. 

```{r}
POI_hotel <- POI_sf %>%
  filter(day == 18 & hour == 12)
tmap_mode("view")

tm_shape(bgmap) +
  tm_rgb(bgmap, r = 1,g = 2,b = 3,
       alpha = NA,
       saturation = 1,
       interpolate = TRUE,
       max.value = 255) +
  tm_shape(POI_hotel) +
  tm_dots(col = "blue")

```

## Respective Owners of Credit and Loyalty Cards

Moving on, we will be trying to see if we can derive the respective owners of the credit and loyalty cards.

The unique counts of the credit cards and loyalty cards are 55 and 54 respectively. This suggests that there might be duplicate usages of either credit or loyalty cards. 

```{r}
unique_cc <- unique(cc_data$last4ccnum)
length(unique_cc)

unique_loyalty <- unique(loyalty_data$loyaltynum)
length(unique_loyalty)
```

First, we will be joining the two datasets by the *day*, *location* and *price*.

```{r}
cc_data$day <- as.factor(get_day(cc_data$timestamp))

loyalty_data$day <- as.factor(get_day(loyalty_data$timestamp))

ccloy <- merge(cc_data, loyalty_data,
               by = c("day", "location", "price")) %>%
  select("timestamp.y", "timestamp.x", "day", "location", "price", "last4ccnum", "loyaltynum")

glimpse(ccloy)
```

Then, we pulled out all of the unique tags to each credit and loyalty card. There is a total of 62 entries, which means that there might be duplicate usage of either credit or loyalty cards.

```{r}
unique_tag <- ccloy %>%
  select("last4ccnum", "loyaltynum") %>%
  distinct(last4ccnum, loyaltynum, .keep_all = TRUE) %>%
  ungroup()

unique_tag$last4ccnum = as.factor(unique_tag$last4ccnum)

DT::datatable(unique_tag, 
              options = list(
                autoWidth = FALSE,
                columnDefs = list(list(width = '1px',
                                       className = 'dt-center',
                                       targets = c(0,1,2))))) %>%
  formatStyle(0,
              target = 'row',
              lineHeight='75%')
```

We also plotted an interactive parallel coordinates plot to see which credit cards and loyalty cards are linked together.

```{r}
parcoords(
 unique_tag[,1:2],
 rownames = FALSE,
 reorderable = T,
 brushMode = '1D-axes')
```

Taking at a look at the duplicates, we can see that there are a total of 7 credit cards that are linked to 2 different loyalty cards each.

```{r}
cc_duplicates = unique_tag[duplicated(unique_tag$last4ccnum)|duplicated(unique_tag$last4ccnum, fromLast=TRUE),] %>%
  arrange(last4ccnum)

DT::datatable(cc_duplicates, 
              options = list(
                autoWidth = FALSE,
                columnDefs = list(list(width = '1px',
                                       className = 'dt-center',
                                       targets = c(0,1,2))))) %>%
  formatStyle(0,
              target = 'row',
              lineHeight='75%')

```

Similarly, for the loyalty cards, there are a total of 8 loyalty cards that are used for 2 different credit card holders.

```{r}
loyalty_dups = unique_tag[duplicated(unique_tag$loyaltynum)|duplicated(unique_tag$loyaltynum, fromLast=TRUE),] %>%
  arrange(loyaltynum)

loyalty_dups <- loyalty_dups[, c("loyaltynum", "last4ccnum")]

DT::datatable(loyalty_dups, 
              options = list(
                autoWidth = FALSE,
                columnDefs = list(list(width = '1px',
                                       className = 'dt-center',
                                       targets = c(0,1,2))))) %>%
  formatStyle(0,
              target = 'row',
              lineHeight='75%')

```

Yet there are uncertainties in the data. The credit card data is timestamped with both date and time while the loyalty card data is timestamped with only dates. This would mean that some matching of data might not be accurate, if there are more than one transactions of the same amount in the same day but at different timings, yet tagged to different credit and loyalty cards. Under this circumstance, it would make it difficult for us to determine which credit card is linked to which loyalty card.
    
## Informal/Unofficial relationships among GASTech Personnel

To look at the informal relationships among the GASTech employees, we first merged the gps data with the car assignment data.

```{r}
car <- read_csv("data/car-assignments.csv")

car$CarID = as.factor(car$CarID)

glimpse(car)
```

```{r}
merged_gps <- left_join(gps, car, 
                        by = c("id" = "CarID"))

merged_gps <- merged_gps[with(merged_gps, order(id,Timestamp)),]

merged_gps <- merged_gps %>% 
  mutate(diff = Timestamp - lag(Timestamp, default = first(Timestamp)))
merged_gps$diff_hr <- round(merged_gps$diff / 60 / 60, 1) 

geog <- merged_gps %>% 
  filter(diff > 600)

glimpse(geog)

```

We then assigned the geographical locations to the corresponding area represented by the longitudes and latitudes. 

```{r}
geog$poi <- 1 
geog <- geog %>% 
  mutate(poi = case_when(
    between(lat, 36.05092013, 36.05102938) & 
      between(long, 24.82586806, 24.82598723)  ~ "Abila Airport", 
    between(lat, 36.07434876, 36.07443715) & 
      between(long, 24.84592966, 24.84598782)  ~ "Abila Scrapyard", 
    between(lat, 36.06342076, 36.06349309) & 
      between(long, 24.85096457, 24.85103679)  ~ "Abila Zacharo", 
    between(lat, 36.07712237, 36.07715385) & 
      between(long, 24.87617634, 24.87621582)  ~ "Ahaggo Museum",
    between(lat, 36.07522801, 36.07530344) & 
      between(long, 24.85626503, 24.85634849)  ~ "Albert's Fine Clothing",
    between(lat, 36.08172086, 36.08182543) & 
      between(long, 24.85086882, 24.85096705)  ~ "Bean There Done That",
    between(lat, 36.05402149, 36.05413903) & 
      between(long, 24.90116515, 24.90128202)  ~ "Brew've Been Served", 
    between(lat, 36.07332048, 36.07336116) & 
      between(long, 24.86416419, 24.86420583)  ~ "Brewed Awakenings", 
    between(lat, 36.05851786, 36.05860144) & 
      between(long, 24.8808655, 24.88092654)  ~ "Carlyle Chemical Inc.", 
    between(lat, 36.07062423, 36.07073983) & 
      between(long, 24.89517609, 24.89526281)  ~ "Chostus Hotel",
    between(lat, 36.05462322, 36.05469486) & 
      between(long, 24.88977034, 24.88983886)  ~ "Coffee Cameleon", 
    between(lat, 36.08954231, 36.08962196) & 
      between(long, 24.86066508, 24.8607611)  ~ "Desafio Golf Course", 
    between(lat, 36.07212045, 36.07213193) & 
      between(long, 24.84132949, 24.84134818)  ~ "Frank's Fuel", 
    between(lat, 36.05492145, 36.05503511) & 
      between(long, 24.90176782, 24.90188061)  ~ "Frydos Autosupply n' More", 
    between(lat, 36.04802098, 36.04805422) & 
      between(long, 24.87956497, 24.87957691)  ~ "GasTech", 
    between(lat, 36.05970763, 36.05981097) & 
      between(long, 24.85797552, 24.8580772)  ~ "Gelatogalore", 
    between(lat, 36.06034564, 36.06043016) & 
      between(long, 24.85646426, 24.85657454)  ~ "General Grocer", 
    between(lat, 36.05572125, 36.05584094) & 
      between(long, 24.90246542, 24.90258487)  ~ "Guy's Gyros", 
    between(lat, 36.06362146, 36.06371539) & 
      between(long, 24.88586605, 24.88595859)  ~ "Hallowed Grounds", 
    between(lat, 36.07660977, 36.07669909) & 
      between(long, 24.85756408, 24.85764247)  ~ "Hippokampos", 
    between(lat, 36.06749651, 36.0675518) & 
      between(long, 24.87330651, 24.873366)  ~ "Jack's Magical Beans", 
    between(lat, 36.06582037, 36.06584879) & 
      between(long, 24.85236427, 24.85241027)  ~ "Kalami Kafenion", 
    between(lat, 36.05442247, 36.05453641) & 
      between(long, 24.89986596, 24.89998054)  ~ "Katerina’s Café",
    between(lat, 36.05292229, 36.05296701) & 
      between(long, 24.84936915, 24.84941679)  ~ "Kronos Capital", 
    between(lat, 36.06582196, 36.06587998) & 
      between(long, 24.8497762, 24.84983936)  ~ "Kronos Mart", 
    between(lat, 36.06523446, 36.06534083) & 
      between(long, 24.83307421, 24.83318494)  ~ "Kronos Pipe and Irrigation", 
    between(lat, 36.06402993, 36.06410072) & 
      between(long, 24.84137818, 24.84144338)  ~ "Maximum Iron and Steel", 
    between(lat, 36.05840347, 36.05849041) & 
      between(long, 24.88546548, 24.88553455)  ~ "Nationwide Refinery", 
    between(lat, 36.05859158, 36.05859887) & 
      between(long, 24.85790261, 24.85799357)  ~ "Octavio's Office Supplies", 
    between(lat, 36.05192066, 36.05197575) & 
      between(long, 24.87076418, 24.87082137)  ~ "Ouzeri Elian", 
    between(lat, 36.06324941, 36.06330782) & 
      between(long, 24.85226894, 24.8523291)  ~ "Roberts and Sons", 
    between(lat, 36.05282139, 36.05288367) & 
      between(long, 24.86856868, 24.8686314)  ~ "Shoppers' Delight", 
    between(lat, 36.05409586, 36.05420832) & 
      between(long, 24.90806584, 24.90817838)  ~ "Stewart and Sons Fabrication", 
    between(lat, 36.06774029, 36.06776587) & 
      between(long, 24.87148791, 24.87150031)  ~ "U-Pump",
    ))

glimpse(geog)

```

One location to identify for informal relationship will be the Chostus Hotel. 

```{r}
hotel <- geog %>% 
  filter(poi == "Chostus Hotel") %>%
  select( poi, Timestamp, id, LastName, FirstName, CurrentEmploymentTitle, CurrentEmploymentType)

knitr::kable(hotel %>%
               arrange(Timestamp),
             caption = "Records in Chostus Hotel")
```

We are able to suspect that Elsa Orilla and Brand Tempestad might have a relationship going on between them, as the both of them has frequented the hotel on four separate days. 

## Evidence of Suspicious Activities

Based on the analysis conducted above, we are able to point out several suspicious activities occurring. 

1. 
